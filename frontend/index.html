<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Payambar - A minimal Telegram-like messenger">
    <meta name="theme-color" content="#ffffff">
    <title>PayamBar</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="/styles.css">
    <script src="/vue.global.prod.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <div class="auth-container" v-if="!isAuthed">
            <div class="auth-card">
                <div class="auth-brand">
                    <div class="auth-logo">P</div>
                    <div class="auth-title">
                        <h1>PayamBar</h1>
                        <p class="auth-subtitle">ูพุงูโุฑุณุงู ุณุงุฏูุ ุณุฑุน ู ุงูู</p>
                        <p class="auth-badge">ูพุงูโุฑุณุงู ุฑูุฒูฺฏุงุฑโุดุฏู</p>
                    </div>
                </div>
                <div class="auth-tabs">
                    <button class="tab-btn" :class="{active: authTab==='login'}" @click="authTab='login'">ูุฑูุฏ</button>
                    <button class="tab-btn" :class="{active: authTab==='register'}"
                        @click="authTab='register'">ุซุจุชโูุงู</button>
                </div>

                <form v-if="authTab==='login'" class="auth-form" @submit.prevent="handleLogin">
                    <input type="text" v-model="login.username" placeholder="ูุงูโฺฉุงุฑุจุฑ" required>
                    <input type="password" v-model="login.password" placeholder="ุฑูุฒโุนุจูุฑ" required>
                    <button type="submit">ูุฑูุฏ ุงูู</button>
                    <div class="error-message" v-if="authError">{{ authError }}</div>
                    <div class="auth-hint">ุฑูุฒ ุนุจูุฑ ููุท ุจุฑุง ุจุงุฒ ฺฉุฑุฏู ฺฉูุฏ ุฑูุฒูฺฏุงุฑ ุดูุง ุงุณุชูุงุฏู ูโุดูุฏ ู ุฐุฎุฑู ููโุดูุฏ.
                    </div>
                </form>

                <form v-else class="auth-form" @submit.prevent="handleRegister">
                    <input type="text" v-model="register.username" placeholder="ูุงูโฺฉุงุฑุจุฑ" required>
                    <input type="password" v-model="register.password" placeholder="ุฑูุฒโุนุจูุฑ" required>
                    <input type="password" v-model="register.confirm" placeholder="ุชฺฉุฑุงุฑ ุฑูุฒโุนุจูุฑ" required>
                    <button type="submit">ุซุจุชโูุงู ุจุง ุฑูุฒูฺฏุงุฑ</button>
                    <div class="error-message" v-if="authError">{{ authError }}</div>
                    <div class="auth-hint">ฺฉูุฏ ุฎุตูุต ุดูุง ููุท ุฑูุฒูฺฏุงุฑโุดุฏู ุฑู ุณุฑูุฑ ูพุดุชุจุงูโฺฏุฑ ูโุดูุฏ ุชุง ุฏุฑ ุฏุณุชฺฏุงูโูุง
                        ุฏฺฏุฑ ุจุงุฒุงุจ ุดูุฏ.</div>
                    <label class="rules-checkbox">
                        <input type="checkbox" v-model="acceptRules">
                        <span>ููุงูู ู ุญุฑู ุฎุตูุต ุฑุง ูโูพุฐุฑู</span>
                    </label>
                </form>
                <div class="auth-footer">
                    <button type="button" class="link-btn" @click="openRulesModal">ูุดุงูุฏู ููุงูู</button>
                </div>
                <div v-if="appVersion" class="auth-version">{{ appVersion }}</div>
            </div>
        </div>

        <div v-if="showRulesModal" class="modal-backdrop" @click.self="closeRulesModal">
            <div class="modal-card">
                <div class="modal-header">
                    <h3>ููุงูู ุงุณุชูุงุฏู ู ุฑูุฒูฺฏุงุฑ</h3>
                    <button class="icon-btn ghost" @click="closeRulesModal">โ</button>
                </div>
                <div class="modal-body">
                    <ul class="rules-list">
                        <li>ูพุงูโูุง ุจู ฺฉุงุฑุจุฑุงู ฺฉู ฺฉูุฏ ุฏุงุฑูุฏุ ุจู ุตูุฑุช ุณุฑุชุงุณุฑ (E2EE) ุฑูุฒูฺฏุงุฑ ูโุดูุฏ.</li>
                        <li>ุงฺฏุฑ ุทุฑู ููุงุจู ูููุฒ ฺฉูุฏ ููุชุดุฑ ูฺฉุฑุฏู ุจุงุดุฏุ ูพุงู ุดูุง ุจูโุตูุฑุช ูุชู ุณุงุฏู ุงุฑุณุงู ูโุดูุฏ ุชุง ูุงุจู
                            ุฎูุงูุฏู ุจูุงูุฏ.</li>
                        <li>ฺฉูุฏ ุฎุตูุต ููุท ุจู ุดฺฉู ุฑูุฒูฺฏุงุฑโุดุฏู ุฑู ุณุฑูุฑ ูพุดุชุจุงูโฺฏุฑ ูโุดูุฏ ู ุจุฏูู ุฑูุฒ ุนุจูุฑ ุดูุง ูุงุจู
                            ุงุณุชูุงุฏู ูุณุช.</li>
                        <li>ูุณุฆููุช ูุญุชูุง ูพุงูโูุงุ ุชุฎููุงุช ู ุนูุงูุจ ุญููู ุจุฑ ุนูุฏู ูุฑุณุชูุฏู ู ุฏุฑุงูุชโฺฉููุฏู ุงุณุชุ ุณุฑูุณ
                            ูุณุฆููุช ูุฏุงุฑุฏ.</li>
                        <li>ุงุฒ ุงุฑุณุงู ูุฑฺฏููู ูุญุชูุง ุบุฑูุงูููุ ุขุฒุงุฑุฏููุฏู ุง ููุถโฺฉููุฏู ุญููู ุฏฺฏุฑุงู ุฎูุฏุฏุงุฑ ฺฉูุฏ.</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="primary-btn" @click="closeRulesModal">ูุชูุฌู ุดุฏู</button>
                </div>
            </div>
        </div>

        <div class="messenger-container" v-if="isAuthed">
            <!-- Chat List Panel -->
            <div class="chat-list-panel" :class="{'mobile-show': chatListOpen}">
                <!-- User Profile Section -->
                <div class="user-profile-section">
                    <div class="user-avatar" @click="showProfileModal = true" style="cursor: pointer;">
                        <img v-if="myAvatarUrl" :src="myAvatarUrl" alt="ุขูุงุชุงุฑ" class="avatar-img">
                        <span v-else>{{ username ? username.charAt(0).toUpperCase() : '?' }}</span>
                    </div>
                    <div class="user-profile-info" @click="showProfileModal = true" style="cursor: pointer;">
                        <div class="user-profile-name">{{ profileDisplayName || (username) }}</div>
                        <div class="user-profile-status">{{ userProfileStatusText }}</div>
                    </div>
                </div>
                <div class="conversations-list">
                    <div v-if="loadingConversations" class="conversation-skeleton-list">
                        <div v-for="n in 6" :key="'skeleton-' + n" class="conversation-item skeleton">
                            <div class="conversation-avatar skeleton-avatar"></div>
                            <div class="conversation-info">
                                <div class="skeleton-line skeleton-name"></div>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="filteredConversations.length === 0" class="empty-state">ูฺ ูฺฉุงูููโุง ูุณุช</div>
                    <div v-else v-for="conv in filteredConversations" :key="conv.id" class="conversation-item"
                        :class="{active: conv.user_id === currentConversationId}" @click="selectConversation(conv)">
                        <div class="conversation-avatar">
                            <img v-if="conv.avatar_url" :src="conv.avatar_url" alt="ุขูุงุชุงุฑ" class="avatar-img">
                            <span v-else>{{ conv.username ? conv.username.charAt(0).toUpperCase() : '?' }}</span>
                            <span v-if="conv.is_online" class="online-indicator"></span>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-username">{{ conv.display_name || (conv.username) }}</div>
                        </div>
                        <div class="conversation-actions">
                            <div v-if="conv.unread_count > 0" class="unread-badge">{{ conv.unread_count }}</div>
                            <button class="conversation-menu-btn" @click.stop="openConversationMenu($event, conv)"
                                aria-label="ฺฏุฒููโูุง ูฺฉุงููู">โฏ</button>
                        </div>
                    </div>
                </div>

                <!-- Floating Action Button -->
                <button class="fab-new-chat" @click="openNewChat" aria-label="ูฺฉุงููู ุฌุฏุฏ" title="ูฺฉุงููู ุฌุฏุฏ">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>

                <!-- Conversation Menu -->
                <div v-if="conversationMenu.show" class="context-menu"
                    :style="{top: conversationMenu.y + 'px', left: conversationMenu.x + 'px'}" @click.stop>
                    <button class="context-menu-item delete" @click="deleteConversation(conversationMenu.conversation)">
                        <span class="context-menu-icon">๐๏ธ</span>
                        <span>ุญุฐู ูฺฉุงููู</span>
                    </button>
                </div>
                <div v-if="conversationMenu.show" class="context-menu-overlay" @click="closeConversationMenu"></div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel" :class="{'mobile-hide': chatListOpen}">
                <div class="panel-header">
                    <div class="chat-header-info">
                        <button class="icon-btn ghost back-btn mobile-only" @click="goBackToList" aria-label="ุจุงุฒฺฏุดุช"
                            v-if="currentConversationId">โ</button>
                        <span v-if="!currentConversationId" class="select-chat">ฺฉ ูฺฉุงููู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ</span>
                        <template v-else>
                            <div class="chat-header-avatar-wrapper">
                                <img v-if="currentConversationAvatarUrl" :src="currentConversationAvatarUrl"
                                    class="chat-header-avatar" alt="avatar">
                                <span v-else class="chat-header-avatar-placeholder">{{ (currentConversationDisplayName
                                    || currentConversationUsername || '?').charAt(0).toUpperCase() }}</span>
                                <span v-if="currentConversationIsOnline" class="online-indicator"></span>
                            </div>
                            <div class="chat-header-text">
                                <span class="chat-header-name">{{ currentConversationDisplayName || (
                                    currentConversationUsername) }}</span>
                                <span class="chat-header-status" v-if="currentConversationIsOnline">ุขููุงู</span>
                            </div>
                        </template>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn ghost call-btn" v-if="currentConversationId" @click="startCall"
                            aria-label="ุชูุงุณ ุตูุช">๐</button>
                        <!-- <button class="icon-btn ghost" v-show="currentConversationId" @click="shareProfile" aria-label="ุงุดุชุฑุงฺฉ ูพุฑููุงู">โ</button> -->
                    </div>
                </div>

                <!-- Active Call Bar -->
                <div v-if="activeCall" class="active-call-bar">
                    <div class="active-call-info">
                        <span class="pulse-icon">โ</span>
                        <span>ุฏุฑ ุญุงู ูฺฉุงููู ุจุง {{ activeCall.displayName || activeCall.username }}</span>
                        <span v-if="callDuration">{{ callDuration }}</span>
                    </div>
                    <div class="active-call-actions">
                        <button class="btn-hangup" @click="endCall">ูุทุน ุชูุงุณ</button>
                    </div>
                </div>

                <div class="messages-container" @scroll="handleMessagesScroll" @touchstart="handlePullStart"
                    @touchmove="handlePullMove" @touchend="handlePullEnd">
                    <div v-if="!currentConversationId" class="empty-state">ฺฉ ูฺฉุงููู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ</div>
                    <div v-else-if="loadingMessages" class="empty-state">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ...</div>
                    <div v-else-if="messagesForCurrent.length === 0" class="empty-state">ูููุฒ ูพุงูโุง ูุฌูุฏ ูุฏุงุฑุฏ</div>
                    <div v-else>
                        <div v-if="loadingOlderMessages" class="loading-older">ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ ูพุงูโูุง ูุฏูโุชุฑ...
                        </div>
                        <div v-if="hasMoreMessages[currentConversationId] && !loadingOlderMessages"
                            class="load-more-hint">ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ูพุงูโูุง ูุฏูโุชุฑ ุจู ุจุงูุง ุงุณฺฉุฑูู ฺฉูุฏ</div>
                        <div v-for="(msg, msgIndex) in messagesForCurrent" :key="msg.id || msg.client_message_id"
                            class="message" :class="Number(msg.sender_id) === Number(userId) ? 'sent' : 'received'">
                            <div class="message-bubble">
                                <template v-if="msg.file_url">
                                    <template v-if="isImageMessage(msg)">
                                        <div class="media-message image-message">
                                            <a :href="msg.file_url" target="_blank" class="message-image-link">
                                                <img :src="msg.file_url" class="message-image"
                                                    :alt="msg.file_name || 'image'">
                                            </a>
                                            <a :href="msg.file_url" target="_blank" class="media-download"
                                                :download="msg.file_name || true" title="ุฏุงูููุฏ ุชุตูุฑ"
                                                aria-label="ุฏุงูููุฏ ุชุตูุฑ">โค</a>
                                        </div>
                                    </template>
                                    <template v-else-if="isVideoMessage(msg)">
                                        <div class="media-message video-message">
                                            <video :src="msg.file_url" class="message-video" controls
                                                preload="metadata"></video>
                                            <a :href="msg.file_url" target="_blank" class="media-download"
                                                :download="msg.file_name || true" title="ุฏุงูููุฏ ูุฏู"
                                                aria-label="ุฏุงูููุฏ ูุฏู">โค</a>
                                        </div>
                                    </template>
                                    <template v-else-if="isAudioMessage(msg)">
                                        <div class="voice-message">
                                            <audio :src="msg.file_url" controls preload="metadata"></audio>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <a :href="msg.file_url" target="_blank" class="file-link" download>
                                            ๐ {{ msg.file_name || 'ุฏุงูููุฏ ูุงู' }}
                                        </a>
                                    </template>
                                </template>
                                <template v-else>{{ msg.content }}</template>
                            </div>
                            <div class="message-footer">
                                <div class="message-meta">
                                    <span class="message-time">{{ formatTime(msg.created_at) }}</span>
                                    <span v-if="shouldShowMessageStatus(msg, msgIndex)" class="message-status">{{
                                        formatStatus(msg) }}</span>
                                </div>
                                <button v-if="Number(msg.sender_id) === Number(userId)" class="message-menu-btn"
                                    @click.stop="openContextMenu($event, msg)" aria-label="ฺฏุฒููโูุง ูพุงู">โฏ</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Pull to refresh indicator (anchored above input bar) -->
                <div v-if="currentConversationId" class="pull-to-refresh-indicator"
                    :class="{ visible: pullToRefresh.pulling || pullToRefresh.refreshing, ready: pullToRefresh.currentY >= pullToRefresh.threshold }"
                    :style="(pullToRefresh.pulling || pullToRefresh.refreshing) ? { transform: `translateY(-${pullToRefresh.currentY}px)` } : null">
                    <div v-if="pullToRefresh.refreshing" class="refresh-spinner">โป</div>
                    <div v-else-if="pullToRefresh.currentY >= pullToRefresh.threshold" class="refresh-hint">ุฑูุง ฺฉูุฏ
                    </div>
                    <div v-else class="refresh-hint">ุจุฑุง ุจุฑูุฒุฑุณุงู ุจู ุจุงูุง ุจฺฉุดุฏ</div>
                </div>

                <!-- Context Menu -->
                <div v-if="contextMenu.show" class="context-menu"
                    :style="{top: contextMenu.y + 'px', left: contextMenu.x + 'px'}" @click.stop>
                    <button class="context-menu-item delete" @click="deleteMessage">
                        <span class="context-menu-icon">๐๏ธ</span>
                        <span>ุญุฐู ูพุงู</span>
                    </button>
                </div>
                <div v-if="contextMenu.show" class="context-menu-overlay" @click="closeContextMenu"></div>

                <div class="message-input-area" v-show="currentConversationId">
                    <div class="input-container">
                        <input type="file" ref="fileInput" @change="handleFileSelect" style="display: none">
                        <button class="icon-btn ghost" @click="$refs.fileInput.click()"
                            aria-label="ูพูุณุช ูุงู">๐</button>
                        <button class="icon-btn ghost" :class="{ recording: recordingVoice }"
                            @click="toggleVoiceRecording" :disabled="uploadingFile || sendingVoice"
                            :aria-label="recordingVoice ? 'ุชููู ุถุจุท' : 'ุถุจุท ุตุฏุง'"
                            :title="recordingVoice ? 'ุชููู ุถุจุท ู ุงุฑุณุงู' : 'ุถุจุท ูพุงู ุตูุช'">๐ค</button>
                        <input type="text" v-model="messageText" placeholder="ูพุงู..." aria-label="ููุดุชู ูพุงู"
                            @keyup.enter="sendMessage">
                        <button class="icon-btn solid" @click="sendMessage" aria-label="ุงุฑุณุงู">></button>
                    </div>
                    <div v-if="recordingVoice" class="recording-indicator">
                        ุฏุฑ ุญุงู ุถุจุท ุตุฏุง: {{ formatRecordingDuration(recordingElapsedSec) }}
                    </div>
                    <div v-if="sendingVoice" class="upload-progress">ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุตูุช...</div>
                    <div v-if="uploadingFile" class="upload-progress">ุฏุฑ ุญุงู ุขูพููุฏ...</div>
                </div>
            </div>

            <!-- New Chat Modal -->
            <div class="modal" v-if="showNewChatModal" @click.self="closeNewChatModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ูฺฉุงููู ุฌุฏุฏ</h3>
                        <button class="close-btn" @click="closeNewChatModal" aria-label="ุจุณุชู">โ</button>
                    </div>
                    <div class="search-user-container">
                        <input type="text" ref="newChatSearchInput" class="search-user-input"
                            v-model="newChatSearchQuery" @input="onNewChatSearchInput"
                            placeholder="ูุงู ฺฉุงุฑุจุฑ ุฑุง ุฌุณุชุฌู ฺฉูุฏ...">
                    </div>
                    <div class="users-list">
                        <p v-if="!newChatSearchQuery.trim()" class="search-hint">ูุงู ฺฉุงุฑุจุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ</p>
                        <p v-else-if="newChatSearchLoading" class="searching">ุฏุฑ ุญุงู ุฌุณุชุฌู...</p>
                        <p v-else-if="newChatSearchError" class="empty">{{ newChatSearchError }}</p>
                        <p v-else-if="newChatSearchResults.length === 0" class="empty">ฺฉุงุฑุจุฑ ุงูุช ูุดุฏ</p>
                        <user-search-item v-else v-for="user in newChatSearchResults" :key="user.id" :user="user"
                            @select="handleSelectSearchedUser"></user-search-item>
                    </div>
                </div>
            </div>

            <!-- Profile Modal -->
            <div class="modal" v-if="showProfileModal" @click.self="showProfileModal = false">
                <div class="modal-content profile-modal-sheet">
                    <div class="modal-header">
                        <h3>ูพุฑููุงู</h3>
                        <button class="close-btn" @click="showProfileModal = false">ร</button>
                    </div>
                    <div class="profile-modal-content">
                        <!-- Avatar Section -->
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-large" @click="$refs.avatarInput.click()"
                                style="cursor: pointer;">
                                <img v-if="myAvatarUrl" :src="myAvatarUrl" alt="ุขูุงุชุงุฑ" class="avatar-img-large">
                                <span v-else>{{ username ? username.charAt(0).toUpperCase() : '?' }}</span>
                                <div class="avatar-edit-overlay">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                                        </path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                </div>
                            </div>
                            <input type="file" ref="avatarInput" @change="handleAvatarUpload" accept="image/*"
                                style="display: none">
                            <div class="profile-avatar-name">{{ profileDisplayName || username }}</div>
                            <button class="btn-logout-inline" @click="handleLogout">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                                ุฎุฑูุฌ ุงุฒ ุญุณุงุจ
                            </button>
                            <div v-if="uploadingAvatar" class="avatar-upload-status">ุฏุฑ ุญุงู ุขูพููุฏ...</div>
                        </div>

                        <!-- Profile Info Section -->
                        <div class="profile-section">
                            <div class="profile-form-group">
                                <label>ูุงู ฺฉุงุฑุจุฑ</label>
                                <input type="text" :value="username" disabled>
                            </div>
                            <div class="profile-form-group">
                                <label>ูุงู ููุงุด</label>
                                <input type="text" v-model="profileDisplayName"
                                    placeholder="ูุงู ููุงุด ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ">
                            </div>
                        </div>

                        <!-- Settings Section -->
                        <div class="profile-section">
                            <div class="profile-form-group push-toggle-group">
                                <label>ุงุนูุงู ูพุงู ุฌุฏุฏ</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" v-model="pushNotificationsEnabled"
                                        @change="togglePushNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="profile-section">
                            <details class="profile-danger-zone">
                                <summary class="danger-summary">ุญุฐู ุญุณุงุจ ฺฉุงุฑุจุฑ</summary>
                                <div class="danger-text">ุจุฑุง ุญุฐู ุญุณุงุจุ ูุงู ฺฉุงุฑุจุฑ ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ. ุงู ุนููุงุช ุบุฑูุงุจู
                                    ุจุงุฒฺฏุดุช ุงุณุช.</div>
                                <input type="text" v-model="deleteAccountConfirm" placeholder="ูุงู ฺฉุงุฑุจุฑ"
                                    class="danger-input">
                                <button class="btn-danger" @click="deleteAccount"
                                    :disabled="deletingAccount || deleteAccountConfirm.trim() !== username">
                                    {{ deletingAccount ? 'ุฏุฑ ุญุงู ุญุฐู...' : 'ุญุฐู ุญุณุงุจ' }}
                                </button>
                            </details>
                        </div>
                    </div>

                    <!-- Sticky Footer -->
                    <div class="profile-modal-footer">
                        <div class="profile-footer-actions">
                            <button class="btn-primary" @click="saveProfile">ุฐุฎุฑู ุชุบุฑุงุช</button>
                        </div>
                        <div v-if="appVersion" class="profile-version">ูุณุฎู {{ appVersion }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Incoming Call Modal -->
        <div v-if="incomingCall" class="modal">
            <div class="modal-content incoming-call-modal">
                <div class="call-avatar">
                    <img v-if="incomingCall.avatar_url" :src="incomingCall.avatar_url" class="avatar-img">
                    <span v-else>{{ incomingCall.username.charAt(0).toUpperCase() }}</span>
                </div>
                <div class="call-info">
                    <h3>{{ incomingCall.displayName || incomingCall.username }}</h3>
                    <p>ุชูุงุณ ุตูุช ูุฑูุฏ...</p>
                </div>
                <div class="call-actions">
                    <button class="btn-accept" @click="acceptCall">
                        <span>๐</span> ูพุฐุฑูุชู
                    </button>
                    <button class="btn-decline" @click="rejectCall">
                        <span>โ</span> ุฑุฏ ฺฉุฑุฏู
                    </button>
                </div>
            </div>
        </div>

        <!-- Calling Modal (Outgoing) -->
        <div v-if="outgoingCall" class="modal">
            <div class="modal-content incoming-call-modal">
                <div class="call-avatar">
                    <img v-if="outgoingCall.avatarUrl" :src="outgoingCall.avatarUrl" class="avatar-img">
                    <span v-else>{{ outgoingCall.username.charAt(0).toUpperCase() }}</span>
                </div>
                <div class="call-info">
                    <h3>{{ outgoingCall.displayName || outgoingCall.username }}</h3>
                    <p v-if="outgoingCall.status === 'ringing'">ุฏุฑ ุญุงู ุฒูฺฏ ุฎูุฑุฏู...</p>
                    <p v-else>ุฏุฑ ุญุงู ุจุฑูุฑุงุฑ ุชูุงุณ...</p>
                </div>
                <div class="call-actions">
                    <button class="btn-decline" @click="endCall">
                        <span>โ</span> ูุบู
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            let refreshing = false;

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });

            const sendSkipWaiting = (registration) => {
                if (registration.waiting) {
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            };

            const watchInstalling = (worker, registration) => {
                if (!worker) return;
                worker.addEventListener('statechange', () => {
                    if (worker.state === 'installed' && registration.waiting) {
                        sendSkipWaiting(registration);
                    }
                });
            };

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('SW registered:', reg.scope);
                        sendSkipWaiting(reg);
                        watchInstalling(reg.installing, reg);
                        reg.addEventListener('updatefound', () => watchInstalling(reg.installing, reg));
                    })
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>
</body>

</html>