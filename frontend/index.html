<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Payambar - A minimal Telegram-like messenger">
    <meta name="theme-color" content="#ffffff">
    <title>PayamBar</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="/styles.css">
    <script src="/vue.global.prod.js"></script>
    <style>[v-cloak] { display: none; }</style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- Offline Banner -->
        <div v-if="isOffline || serverOffline" class="offline-banner">
            {{ isOffline ? 'Ø¢ÙÙ„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒØ¯' : 'Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‚Ø·Ø¹ Ø´Ø¯' }}
        </div>

        <div class="auth-container" v-if="!isAuthed">
            <div class="auth-card">
                <h1>PayamBar</h1>
                <div class="auth-tabs">
                    <button class="tab-btn" :class="{active: authTab==='login'}" @click="authTab='login'">ÙˆØ±ÙˆØ¯</button>
                    <button class="tab-btn" :class="{active: authTab==='register'}" @click="authTab='register'">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                </div>
                
                <form v-if="authTab==='login'" class="auth-form" @submit.prevent="handleLogin">
                    <input type="text" v-model="login.username" placeholder="Ù†Ø§Ù…â€ŒÚ©Ø§Ø±Ø¨Ø±ÛŒ" required>
                    <input type="password" v-model="login.password" placeholder="Ø±Ù…Ø²â€ŒØ¹Ø¨ÙˆØ±" required>
                    <button type="submit">ÙˆØ±ÙˆØ¯</button>
                    <div class="error-message">{{ authError }}</div>
                </form>

                <form v-else class="auth-form" @submit.prevent="handleRegister">
                    <input type="text" v-model="register.username" placeholder="Ù†Ø§Ù…â€ŒÚ©Ø§Ø±Ø¨Ø±ÛŒ" required>
                    <input type="password" v-model="register.password" placeholder="Ø±Ù…Ø²â€ŒØ¹Ø¨ÙˆØ±" required>
                    <input type="password" v-model="register.confirm" placeholder="ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø²â€ŒØ¹Ø¨ÙˆØ±" required>
                    <button type="submit">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                    <div class="error-message">{{ authError }}</div>
                </form>
            </div>
        </div>

        <div class="messenger-container" v-else>
            <!-- Chat List Panel -->
            <div class="chat-list-panel" :class="{'mobile-show': chatListOpen}">
                <!-- User Profile Section -->
                <div class="user-profile-section">
                    <div class="user-avatar" @click="showProfileModal = true" style="cursor: pointer;">
                        <img v-if="myAvatarUrl" :src="myAvatarUrl" alt="Ø¢ÙˆØ§ØªØ§Ø±" class="avatar-img">
                        <span v-else>{{ username ? username.charAt(0).toUpperCase() : '?' }}</span>
                    </div>
                    <div class="user-profile-info" @click="showProfileModal = true" style="cursor: pointer;">
                        <div class="user-profile-name">{{ profileDisplayName || ('@' + username) }}</div>
                        <div class="user-profile-status">Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
                    </div>
                    <button class="logout-btn" @click="handleLogout">Ø®Ø±ÙˆØ¬</button>
                </div>
                
                <div class="panel-header">
                    <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
                    <button class="icon-btn ghost" @click="openNewChat" aria-label="Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¬Ø¯ÛŒØ¯">ï¼‹</button>
                </div>
                <div class="search-bar">
                    <span class="icon-text" aria-hidden="true">âŒ•</span>
                    <input type="text" v-model="searchQuery" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ú©Ø§Ù„Ù…Ù‡..." aria-label="Ø¬Ø³ØªØ¬Ùˆ Ù…Ú©Ø§Ù„Ù…Ù‡">
                </div>
                <div class="conversations-list">
                    <div v-if="filteredConversations.length === 0" class="empty-state">Ù‡ÛŒÚ† Ù…Ú©Ø§Ù„Ù…Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª</div>
                    <div v-else 
                        v-for="conv in filteredConversations" 
                        :key="conv.id"
                        class="conversation-item"
                        :class="{active: conv.user_id === currentConversationId}"
                        @click="selectConversation(conv)">
                        <div class="conversation-avatar">
                            <img v-if="conv.avatar_url" :src="conv.avatar_url" alt="Ø¢ÙˆØ§ØªØ§Ø±" class="avatar-img">
                            <span v-else>{{ conv.username ? conv.username.charAt(0).toUpperCase() : '?' }}</span>
                            <span v-if="conv.is_online" class="online-indicator"></span>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-username">{{ conv.display_name || ('@' + conv.username) }}</div>
                            <div class="conversation-preview">{{ formatDate(conv.last_message_at) || 'Ù†Ùˆ' }}</div>
                        </div>
                        <div v-if="conv.unread_count > 0" class="unread-badge">{{ conv.unread_count }}</div>
                    </div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel" :class="{'mobile-hide': chatListOpen}">
                <div class="panel-header">
                    <div class="chat-header-info">
                        <button class="icon-btn ghost back-btn mobile-only" @click="goBackToList" aria-label="Ø¨Ø§Ø²Ú¯Ø´Øª" v-if="currentConversationId">â†’</button>
                        <span v-if="!currentConversationId" class="select-chat">ÛŒÚ© Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</span>
                        <template v-else>
                            <div class="chat-header-avatar-wrapper">
                                <img v-if="currentConversationAvatarUrl" :src="currentConversationAvatarUrl" class="chat-header-avatar" alt="avatar">
                                <span v-else class="chat-header-avatar-placeholder">{{ (currentConversationDisplayName || currentConversationUsername || '?').charAt(0).toUpperCase() }}</span>
                                <span v-if="currentConversationIsOnline" class="online-indicator"></span>
                            </div>
                            <div class="chat-header-text">
                                <span class="chat-header-name">{{ currentConversationDisplayName || ('@' + currentConversationUsername) }}</span>
                                <span class="chat-header-status" v-if="currentConversationIsOnline">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                            </div>
                        </template>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn ghost" v-show="currentConversationId" @click="shareProfile" aria-label="Ø§Ø´ØªØ±Ø§Ú© Ù¾Ø±ÙˆÙØ§ÛŒÙ„">â†—</button>
                    </div>
                </div>

                <div class="messages-container" 
                    @scroll="handleMessagesScroll"
                    @touchstart="handlePullStart"
                    @touchmove="handlePullMove"
                    @touchend="handlePullEnd">
                    <!-- Pull to refresh indicator -->
                    <div class="pull-to-refresh-indicator" 
                        :class="{ visible: pullToRefresh.pulling || pullToRefresh.refreshing }"
                        :style="{ transform: `translateY(${pullToRefresh.currentY}px)` }">
                        <div v-if="pullToRefresh.refreshing" class="refresh-spinner">â†»</div>
                        <div v-else-if="pullToRefresh.currentY >= pullToRefresh.threshold" class="refresh-hint">Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯</div>
                        <div v-else class="refresh-hint">Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ú©Ø´ÛŒØ¯</div>
                    </div>
                    <div v-if="!currentConversationId" class="empty-state">ÛŒÚ© Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                    <div v-else-if="loadingMessages" class="empty-state">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                    <div v-else-if="messagesForCurrent.length === 0" class="empty-state">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>
                    <div v-else>
                        <div v-if="loadingOlderMessages" class="loading-older">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±...</div>
                        <div v-if="hasMoreMessages[currentConversationId] && !loadingOlderMessages" class="load-more-hint">Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù†ÛŒØ¯</div>
                        <div v-for="msg in messagesForCurrent" :key="msg.id || msg.client_message_id" class="message" :class="Number(msg.sender_id) === Number(userId) ? 'sent' : 'received'" @contextmenu.prevent="openContextMenu($event, msg)" @touchstart="handleTouchStart($event, msg)" @touchend="handleTouchEnd" @touchmove="handleTouchMove">
                            <div>
                                <div class="message-bubble">
                                    <template v-if="msg.file_url">
                                        <a :href="msg.file_url" target="_blank" class="file-link" download>
                                            ğŸ“ {{ msg.file_name || 'Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„' }}
                                        </a>
                                    </template>
                                    <template v-else>{{ msg.content }}</template>
                                </div>
                                <div class="message-meta">
                                    <span class="message-time">{{ formatTime(msg.created_at) }}</span>
                                    <span class="message-status">{{ formatStatus(msg) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Context Menu -->
                <div v-if="contextMenu.show" class="context-menu" :style="{top: contextMenu.y + 'px', left: contextMenu.x + 'px'}" @click.stop>
                    <button class="context-menu-item delete" @click="deleteMessage">
                        <span class="context-menu-icon">ğŸ—‘ï¸</span>
                        <span>Ø­Ø°Ù Ù¾ÛŒØ§Ù…</span>
                    </button>
                </div>
                <div v-if="contextMenu.show" class="context-menu-overlay" @click="closeContextMenu"></div>

                <div class="message-input-area" v-show="currentConversationId">
                    <div class="input-container">
                        <input type="file" ref="fileInput" @change="handleFileSelect" style="display: none">
                        <button class="icon-btn ghost" @click="$refs.fileInput.click()" aria-label="Ù¾ÛŒÙˆØ³Øª ÙØ§ÛŒÙ„">ğŸ“</button>
                        <input type="text" v-model="messageText" placeholder="Ù¾ÛŒØ§Ù…..." aria-label="Ù†ÙˆØ´ØªÙ† Ù¾ÛŒØ§Ù…" @keyup.enter="sendMessage">
                        <button class="icon-btn solid" @click="sendMessage" aria-label="Ø§Ø±Ø³Ø§Ù„">></button>
                    </div>
                    <div v-if="uploadingFile" class="upload-progress">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...</div>
                </div>
            </div>

            <!-- Profile Modal -->
            <div class="modal" v-if="showProfileModal" @click.self="showProfileModal = false">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h3>
                        <button class="close-btn" @click="showProfileModal = false">Ã—</button>
                    </div>
                    <div class="profile-modal-content">
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-large" @click="$refs.avatarInput.click()" style="cursor: pointer;">
                                <img v-if="myAvatarUrl" :src="myAvatarUrl" alt="Ø¢ÙˆØ§ØªØ§Ø±" class="avatar-img-large">
                                <span v-else>{{ username ? username.charAt(0).toUpperCase() : '?' }}</span>
                            </div>
                            <input type="file" ref="avatarInput" @change="handleAvatarUpload" accept="image/*" style="display: none">
                            <div style="font-size: 0.85rem; color: var(--muted);">Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
                            <div v-if="uploadingAvatar" style="font-size: 0.85rem; color: var(--primary);">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...</div>
                        </div>
                        <div class="profile-form">
                            <div class="profile-form-group">
                                <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                                <input type="text" :value="username" disabled>
                            </div>
                            <div class="profile-form-group">
                                <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                                <input type="text" v-model="profileDisplayName" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                            </div>
                            <div class="profile-actions">
                                <button class="btn-secondary" @click="showProfileModal = false">Ø¨Ø³ØªÙ†</button>
                                <button class="btn-primary" @click="saveProfile">Ø°Ø®ÛŒØ±Ù‡</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
